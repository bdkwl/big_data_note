## HDFS体系结构

HDFS采用了主从（Master/Slave）结构模型，一个HDFS集群包括一个名称节点（NameNode）和若干个数据节点（DataNode）

名称节点作为中心服务器，负责管理文件系统的命名空间及客户端对文件的访问

集群中的数据节点一般是一个节点运行一个数据节点进程，负责处理文件系统客户端的读/写请求，在名称节点的统一调度下进行数据块的创建、删除和复制等操作

每个数据节点的数据实际上是保存在本地Linux文件系统中的

![体系结构](https://raw.githubusercontent.com/bdkwl/big_data_note/master/%E5%88%86%E5%B8%83%E5%BC%8F%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9FHDFS/%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84.png)

### HDFS命名空间管理
- HDFS的命名空间包含目录、文件和块
- 在HDFS1.0体系结构中，在整个HDFS集群中只有一个命名空间，并且只有唯一一个名称节点，该节点负责对这个命名空间进行管理
- HDFS使用的是传统的分级文件体系，因此，用户可以像使用普通文件系统一样，创建、删除目录和文件，在目录间转移文件，重命名文件等

### HDFS通信协议
- HDFS是一个部署在集群上的分布式文件系统，因此，很多数据需要通过网络进行传输
- 所有的HDFS通信协议都是构建在TCP/IP协议基础之上的
- 客户端通过一个可配置的端口向名称节点主动发起TCP连接，并使用客户端协议与名称节点进行交互
- 名称节点和数据节点之间则使用数据节点协议进行交互
- 客户端与数据节点的交互是通过RPC（Remote Procedure Call）来实现的。在设计上，名称节点不会主动发起RPC，而是响应来自客户端和数据节点的RPC请求

### HDFS客户端
客户端是用户操作HDFS最常用的方式，HDFS在部署时都提供了客户端

- HDFS客户端是一个库，暴露了HDFS文件系统接口，这些接口隐藏了HDFS实现中的大部分复杂性
- 客户端可以支持打开、读取、写入等常见的操作，并且提供了类似Shell的命令行方式来访问HDFS中的数据
- HDFS也提供了Java API，作为应用程序访问文件系统的客户端编程接口

### HDFS1.0体系结构的局限性
HDFS1.0 只设置唯一一个名称节点，简化了系统设计，也带来了一些明显的局限性：
1. 命名空间的限制：名称节点是保存在内存中的，因此，名称节点能够容纳的对象（文件、块）的个数会受到内存空间大小的限制
2. 性能的瓶颈：整个分布式文件系统的吞吐量，受限于单个名称节点的吞吐量
3. 隔离问题：由于集群中只有一个名称节点，只有一个命名空间，因此，无法对不同应用程序进行隔离
4. 集群的可用性：一旦这个唯一的名称节点发生故障，会导致整个集群变得不可用

---

## HDFS存储原理

### 冗余数据保存
作为一个分布式文件系统，为了保证系统的容错性和可用性，HDFS采用了多副本方式对数据进行冗余存储，通常一个数据块的多个副本会被分布到不同的数据节点上

![冗余数据保存](https://raw.githubusercontent.com/bdkwl/big_data_note/master/%E5%88%86%E5%B8%83%E5%BC%8F%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9FHDFS/%E5%86%97%E4%BD%99%E6%95%B0%E6%8D%AE.png)

如图所示，数据块1被分别存放到数据节点A和C上，数据块2被存放在数据节点A和B上。这种多副本方式具有以下几个优点：

1. 加快数据传输速度
2. 容易检查数据错误
3. 保证数据可靠性


### 数据存取策略
数据存放

![数据存放](https://raw.githubusercontent.com/bdkwl/big_data_note/master/%E5%88%86%E5%B8%83%E5%BC%8F%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9FHDFS/%E6%95%B0%E6%8D%AE%E5%AD%98%E6%94%BE.png)

- 第一个副本：放置在上传文件的数据节点；如果是集群外提交，则随机挑选一台磁盘不太满、CPU不太忙的节点 （Block1 -> DataNode1）
- 第二个副本：放置在与第一个副本不同的机架的节点上 （Block2 -> DataNode4）
- 第三个副本：与第一个副本相同机架的其他节点上 （Block3 -> DataNode2）
- 更多副本：随机节点

数据读取

- HDFS提供了一个API可以确定一个数据节点所属的机架ID，客户端也可以调用API获取自己所属的机架ID
- 当客户端读取数据时，从名称节点获得数据块不同副本的存放位置列表，列表中包含了副本所在的数据节点，可以调用API来确定客户端和这些数据节点所属的机架ID，当发现某个数据块副本对应的机架ID和客户端对应的机架ID相同时，就优先选择该副本读取数据，如果没有发现，就随机选择一个副本读取数据

### 数据错误与恢复
HDFS具有较高的容错性，可以兼容廉价的硬件，它把硬件出错看作一种常态，而不是异常，并设计了相应的机制检测数据错误和进行自动恢复。主要情况包括：

1. 名称节点出错
	名称节点保存了所有的元数据信息，其中，最核心的两大数据结构是FsImage和Editlog，如果这两个文件发生损坏，那么整个HDFS实例将失效
	
	HDFS设置了备份机制，把这些核心文件同步复制到备份服务器SecondaryNameNode上。当名称节点出错时，就可以根据备份服务器SecondaryNameNode中的FsImage和Editlog数据进行恢复
	
2. 数据节点出错
	- 每个数据节点会定期向名称节点发送“心跳”信息，向名称节点报告自己的状态
	- 当数据节点发生故障，或者网络发生断网时，名称节点就无法收到来自一些数据节点的心跳信息，这时，这些数据节点就会被标记为“宕机”，节点上面的所有数据都会被标记为“不可读”，名称节点不会再给它们发送任何I/O请求
	- 有可能出现一种情形，即由于一些数据节点的不可用，会导致一些数据块的副本数量小于冗余因子
	- 名称节点会定期检查这种情况，一旦发现某个数据块的副本数量小于冗余因子，就会启动数据冗余复制，为它生成新的副本
	- HDFS和其它分布式文件系统的最大区别就是可以调整冗余数据的位置
3. 数据出错
	- 网络传输和磁盘错误等因素，都会造成数据错误
	- 客户端在读取到数据后，会采用md5和sha1对数据块进行校验，以确定读取到正确的数据
	- 在文件被创建时，客户端就会对每一个文件块进行信息摘录，并把这些信息写入到同一个路径的隐藏文件里面
	- 当客户端读取文件的时候，会先读取该信息文件，然后，利用该信息文件对每个读取的数据块进行校验，如果校验出错，客户端就会请求到另外一个数据节点读取该文件块，并且向名称节点报告这个文件块有错误，名称节点会定期检查并且重新复制这个块
